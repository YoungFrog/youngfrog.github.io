<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:title" content="Google : OAuth2 vs Service accounts vs API Key" />
    <meta property="og:site_name" content="Le journal de YoungFrog" />
    <meta property="og:description" content="L'état de ma compréhension, incomplète, de l'identification (authentification) pour utiliser les API Google" />
    
    <meta property="og:type" content="article" />
    <meta property="og:author:username" content="youngfrog" />
    
    <meta property="og:image" content="https://youngfrog.lavnir.be/pics/DSC00035_mod_400x400.JPG">
    
    <meta property="og:url" content="https://youngfrog.lavnir.be/informatique/2020/11/01/google-oauth2-vs-service-accounts-vs-api-key.html">
    
    <meta property="article:tag" content="informatique">
    
    <title>Google : OAuth2 vs Service accounts vs API Key</title>
    <meta name="description" content="Les errements de ma pensée, parfois nus, parfois enrobés. Mes écrits n'engagent que ceux qui y croient, mais pas trop.">
    <meta property="fb:app_id" content="237195747511348"/>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://youngfrog.lavnir.be/informatique/2020/11/01/google-oauth2-vs-service-accounts-vs-api-key.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Le journal de YoungFrog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About -- À propos</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/category/jepensetouthaut/">jepensetouthaut</a>
          
        
          
          <a class="page-link" href="/category/informatique/">informatique</a>
          
        
          
          <a class="page-link" href="/category/enseignement/">enseignement</a>
          
        
          
          <a class="page-link" href="/category/blog/">blog</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Google : OAuth2 vs Service accounts vs API Key</h1>
    <p class="post-meta">Nov 1, 2020</p>
    
     <blockquote>Résumé : L'état de ma compréhension, incomplète, de l'identification (authentification) pour utiliser les API Google</blockquote> 
    
  </header>

  <article class="post-content">
      <ul>
  <li><a href="#pourquoi-je-mintéresse-à-lidentification">Pourquoi je m’intéresse à l’identification</a>
    <ul>
      <li><a href="#publier-sur-le-web">Publier sur le Web</a></li>
      <li><a href="#publier-sur-le-web-en-json">Publier sur le Web en JSON</a></li>
      <li><a href="#via-lapi-sans-identification">Via l’API sans identification</a></li>
      <li><a href="#via-lapi-avec-identification">Via l’API avec identification</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
    </ul>
  </li>
  <li><a href="#quelques-détails-sur-lidentification-authentification">Quelques détails sur l’identification (authentification)</a>
    <ul>
      <li><a href="#oauth">OAuth</a></li>
      <li><a href="#api-key">API Key</a>
        <ul>
          <li><a href="#mais-je-comprends-pas-tout">Mais je comprends pas tout</a></li>
        </ul>
      </li>
      <li><a href="#compte-de-service">Compte de service</a></li>
    </ul>
  </li>
</ul>


      <h2 id="pourquoi-je-mintéresse-à-lidentification">Pourquoi je m’intéresse à l’identification</h2>

<p>Depuis quelques jours je m’intéresse à un problème simple : 
récupérer des infos depuis une Google Sheet (publique) via javascript.
TL;DR : je n’y arrive pas.</p>

<p>Pour faire simple, c’était possible mais ça ne l’est plus trop.</p>

<h3 id="publier-sur-le-web">Publier sur le Web</h3>
<p>Une solution était de “publier sur le Web”, ce qui peut se faire en csv, la ressource visée (via le menu Fichier de l’interface Sheets).
Malheureusement l’URL n’est pas (plus) utilisable depuis javascript à défaut de CORS approprié. Il semblerait que ce soit un changement voulu par Google :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hi,
I've extensively reported this issue to Google and this was their final answer :

	After verifying too the logs, there were changes on how the files are downloaded from the published link, which were done to help protect the published links as a part of Google Cloud's ongoing work to keep its products secure.

	As the published links were not designed to be used programmatically, it is recommend to use the Drive API call files.export [1] instead (requires a project, subject to quotas) to download the file:
	[1] https://developers.google.com/drive/api/v3/reference/files/export

	As an alternative too from the update, I suggest using the search term below to help check other Google Sheets link format that can be tried or tested, to help export them as a CSV file without redirection:

	download link for google spreadsheets CSV export with multiple sheets
</code></pre></div></div>

<p>(Source: <a href="https://support.google.com/docs/thread/56845119">https://support.google.com/docs/thread/56845119</a>)</p>

<h3 id="publier-sur-le-web-en-json">Publier sur le Web en JSON</h3>
<p>D’après <a href="https://www.freecodecamp.org/news/cjn-google-sheets-as-json-endpoint/">https://www.freecodecamp.org/news/cjn-google-sheets-as-json-endpoint/</a>, c’était même possible en Json. Même procédure. Même impossibilité.</p>

<h3 id="via-lapi-sans-identification">Via l’API sans identification</h3>

<p>Une autre solution eut été d’utiliser l’API officielle. 
D’après <a href="https://developers.google.com/drive/api/v3/reference/files/export">https://developers.google.com/drive/api/v3/reference/files/export</a> on doit pouvoir faire des appels non-authentifié à l’API mais j’obtiens toujours une erreur.</p>

<h3 id="via-lapi-avec-identification">Via l’API avec identification</h3>

<p>Pour s’identifier, il faut un secret partagé, et ce n’est pas compatible avec une application côté client.</p>

<h3 id="conclusion">Conclusion</h3>
<p>Le problème reste non-résolu. Malgré tout, cela m’a incité à comprendre mieux l’identification “sauce Google”.</p>

<h2 id="quelques-détails-sur-lidentification-authentification">Quelques détails sur l’identification (authentification)</h2>

<p>J’identifie dans un premier temps trois mécanismes d’identification :</p>

<ul>
  <li>OAuth</li>
  <li>API Key</li>
  <li>OAuth pour les comptes de service</li>
</ul>

<p>(voir <a href="https://console.developers.google.com/apis/credentials/">https://console.developers.google.com/apis/credentials/</a>, qui propose un menu “Aidez-moi à choisir”)</p>

<!-- Ce menu signale que si on veut une application Javascript qui utilise (des données publiques)(iirc), il n'y a pas de solution. -->

<p>Le choix dépendra du type de données auxquelles il faut pouvoir accéder, respectivement :</p>

<ul>
  <li>Données de l’utilisateur utilisant l’application (OAuth)</li>
  <li>Données de l’utilisateur développant l’application (API Key)</li>
  <li>Données non-spécifiques à un utilisateur, mais spécifiques à l’application (compte de service)</li>
</ul>

<h3 id="oauth">OAuth</h3>

<p>Le principe est que l’utilisateur de l’application s’identifie en tant qu’utilisateur de Google, afin que l’application puisse utiliser ses données Google.
Cela ne correspond pas à mon cas d’utilisation puisque je ne veux pas utiliser les données de l’utilisateur courant.</p>

<p>Source: <a href="https://developers.google.com/sheets/api/quickstart/python">https://developers.google.com/sheets/api/quickstart/python</a></p>

<h3 id="api-key">API Key</h3>

<p>Je comprends qu’une API key permet d’accéder aux données du compte ayant servi à générer la clef en question. 
<!-- Je ne suis pas sûr, je n'ai pas testé récemment. --></p>

<p>Ceci peut correspondre à mon cas d’utilisation même si en réalité les données sont publiques, mais le fait que cette clef est liée à mon compte n’est probablement pas idéal.</p>

<h4 id="mais-je-comprends-pas-tout">Mais je comprends pas tout</h4>

<p>On doit pouvoir tester via <a href="https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets.values/get">la documentation de l’API</a></p>

<p>La clef API doit être gardée en sécurité, i.e. pas utilisée côté client : <a href="https://support.google.com/googleapi/answer/6310037">https://support.google.com/googleapi/answer/6310037</a>
C’est un peu louche que sur <a href="https://developers.google.com/sheets/api/quickstart/js">https://developers.google.com/sheets/api/quickstart/js</a> on propose de mettre la clef API dans le code JS… mais on y met aussi un Client ID. Est-ce en réalité du OAuth ?!</p>

<h3 id="compte-de-service">Compte de service</h3>

<p>(source: <a href="https://github.com/googleapis/google-api-python-client/blob/master/docs/oauth-server.md">https://github.com/googleapis/google-api-python-client/blob/master/docs/oauth-server.md</a>)</p>

<p>J’ai dû créer un compte de service, créer une clé dessus, ce qui me télécharge un fichier <code class="language-plaintext highlighter-rouge">.json</code>.</p>

<p>J’ai ensuite créé ce programme Python qui me crée un fichier <code class="language-plaintext highlighter-rouge">resultat.json</code> :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kn">from</span> <span class="nn">googleapiclient.discovery</span> <span class="kn">import</span> <span class="n">build</span>
	<span class="kn">from</span> <span class="nn">google.oauth2</span> <span class="kn">import</span> <span class="n">service_account</span>
	<span class="kn">import</span> <span class="nn">json</span>

	<span class="n">SCOPES</span> <span class="o">=</span> <span class="p">[</span><span class="s">'https://www.googleapis.com/auth/spreadsheets.readonly'</span><span class="p">]</span>
	<span class="c1"># obviously adjust this to your needs
</span>	<span class="n">SERVICE_ACCOUNT_FILE</span> <span class="o">=</span> <span class="s">'credentials.json'</span>

	<span class="c1"># The Sheet ID where the data is stored.
</span>	<span class="n">SHEET_ID</span> <span class="o">=</span> <span class="s">'1x9ZtVIWmPetmmIYNCs6yZoByBH4hCa9w5Z7zOM2vcTM'</span>
	<span class="n">RANGE_NAME</span> <span class="o">=</span> <span class="s">'Feuille 1!A1:B'</span>


	<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
		<span class="s">"""Shows basic usage of the Sheets API.
		Prints values from a sample spreadsheet.
		"""</span>
		<span class="n">creds</span> <span class="o">=</span> <span class="n">service_account</span><span class="p">.</span><span class="n">Credentials</span><span class="p">.</span><span class="n">from_service_account_file</span><span class="p">(</span>
			<span class="n">SERVICE_ACCOUNT_FILE</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">SCOPES</span><span class="p">)</span>
		<span class="n">service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s">'sheets'</span><span class="p">,</span> <span class="s">'v4'</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">creds</span><span class="p">)</span>

		<span class="c1"># Call the Sheets API
</span>		<span class="n">sheet</span> <span class="o">=</span> <span class="n">service</span><span class="p">.</span><span class="n">spreadsheets</span><span class="p">()</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">sheet</span><span class="p">.</span><span class="n">values</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="n">spreadsheetId</span><span class="o">=</span><span class="n">SHEET_ID</span><span class="p">,</span>
									<span class="nb">range</span><span class="o">=</span><span class="n">RANGE_NAME</span><span class="p">).</span><span class="n">execute</span><span class="p">()</span>
		<span class="n">values</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'values'</span><span class="p">,</span> <span class="p">[])</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
			<span class="k">print</span><span class="p">(</span><span class="s">'No data found.'</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"resultat.json"</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
				<span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">outfile</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
		<span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Le journal de YoungFrog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Le journal de YoungFrog</li>
          <li><a href="mailto:nrichard@members.fsf.org">nrichard@members.fsf.org</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/youngfrog">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">youngfrog</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/youngfrog">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">youngfrog</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Les errements de ma pensée, parfois nus, parfois enrobés. Mes écrits n'engagent que ceux qui y croient, mais pas trop.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
